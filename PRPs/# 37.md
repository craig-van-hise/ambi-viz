# Product Requirements Prompt (PRP)

## 1. Project Context & Objectives
**Project:** AmbiViz (Ambisonic Visualization Application)
**Current State:** Audio Yaw decoupling was successfully implemented. We are now executing the visual component of **PRP #26 (Visual-Cognitive Alignment)**.
**Objective:** The visual gaze indicator (the Green Arrow) currently reflects an inverted pitch relative to the user's physical head movement (upside-down wiring). You must invert the Pitch (X-axis) strictly for this visual mesh without altering the underlying Camera quaternion, the UI sliders, or the Audio Engine's SharedArrayBuffer (SAB) state.

## 2. Technical Decisions & Dependencies
* **Architectural Pattern (Mesh-Level Decoupling):** The inversion must happen entirely within the visual rendering layer, specifically where the Green Arrow mesh is updated in the Three.js scene (expected location: `src/visualizer/AmbiScene.ts` or equivalent visual manager).
* **Mathematical Implementation:**
  1. Intercept the tracking quaternion right before it is applied to the Green Arrow object.
  2. Convert the quaternion to Euler angles using Three.js `Euler` with the project's standard 'YXZ' rotation order.
  3. Apply the inversion: $Pitch_{arrow} = -Pitch_{tracker}$ (negate the X-axis component).
  4. Reconstruct the target quaternion from the modified Euler angles and apply it *only* to the Green Arrow mesh.
* **Strict Guardrails:** DO NOT touch `src/HeadTrackingService.ts`, `src/audio/AudioEngine.ts`, or the core `camera.quaternion`. This is a purely cosmetic mesh transformation. 

## 3. Implementation Phases

### Phase 1: Test-Driven Development (TDD) for Visual Pitch Inversion
* **Objective:** Establish failing tests ensuring the Green Arrow's orientation logic operates independently of the core camera and audio states, specifically targeting the X-axis inversion.
* **Instructions:** Locate the unit tests for the visualizer scene (likely `AmbiScene.test.ts`). Add tests that mock the incoming tracking quaternion and verify the resulting orientation of the Green Arrow mesh.
* **TDD Checkpoint:**
    * **Test Case 1:** [Given a tracking update with a positive Pitch (e.g., looking UP, representing an X-axis rotation of $\pi/4$), When the scene updates the Green Arrow, Assert that the Arrow's local Euler X rotation is exactly $-\pi/4$.]
    * **Test Case 2:** [Given the same tracking update, Assert that the core `camera.rotation.x` remains unaffected by the Arrow's inversion logic.]
    * **Mocking Requirements:** Mock the Three.js Scene and the specific Green Arrow mesh/ArrowHelper to inspect its `.quaternion` or `.rotation` properties post-update.
    * **AGENT INSTRUCTION:** "Write and execute these tests in the project's testing framework. Ensure they fail initially. Do not proceed to Phase 2 until all tests in this checkpoint output a PASS."

### Phase 2: Implement Mesh-Specific Pitch Inversion
* **Objective:** Apply the isolated mathematical fix to the Green Arrow's render loop update.
* **Instructions:** 1. Open `src/visualizer/AmbiScene.ts` (or the file responsible for updating the Green Arrow).
  2. Locate the specific `update()` or `animate()` loop where the head tracking state is applied to the Arrow mesh.
  3. Instantiate a temporary `THREE.Euler` and `THREE.Quaternion` at the class scope to prevent per-frame garbage collection.
  4. In the update function:
     - Set the temporary Euler from the incoming tracking quaternion (order 'YXZ').
     - Negate the `x` property.
     - Set the temporary Quaternion from the Euler.
     - Apply this temporary Quaternion directly to `greenArrowMesh.quaternion`.
* **TDD Checkpoint:**
    * **Test Case 1:** [Given the application is running, When the user tilts their head down (negative pitch), Assert that the Green Arrow object rotates downwards, while the Audio SAB and Camera pitch remain correctly aligned with their respective rules.]
    * **AGENT INSTRUCTION:** "Run the full Vitest suite. Ensure all previous tests (including the PRP #25 3DOF fixes and the recent Audio Yaw decoupling) still pass perfectly. No regressions are permitted."

## 4. Final Review
* **AGENT INSTRUCTION:** 1. Audit `AmbiScene.ts` to guarantee no new `new THREE.Euler()` or `new THREE.Quaternion()` calls were placed inside the `requestAnimationFrame` loop.
  2. Confirm via the DOM/UI that the Pitch/Yaw/Roll sliders still move correctly according to the universal polling system (PRP #22).
  3. Verify that the audio panning remains completely unaffected by this cosmetic change.