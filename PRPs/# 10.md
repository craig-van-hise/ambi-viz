# Product Requirements Prompt (PRP): Fix Worklet Fetch Exception

## 1. Project Context & Objectives
The `AudioWorkletProcessor` is failing to instantiate the OBR WASM module with a `ReferenceError: fetch is not defined`. This occurs because `AudioWorkletGlobalScope` lacks network capabilities. The objective is to fetch the `obr.wasm` binary on the main thread and inject it into the worklet via `processorOptions.wasmBinary` to bypass Emscripten's internal fetching mechanism.

## 2. Technical Decisions
* **Main Thread Fetching**: The main thread (`OBRDecoder.ts` or `AudioEngine.ts`) will fetch `/obr.wasm` and convert it to an `ArrayBuffer`.
* **Emscripten `wasmBinary` Override**: The `ModuleFactory` exported by Emscripten accepts a configuration object. Providing `{ wasmBinary: ArrayBuffer }` forces Emscripten to skip all XHR/fetch logic and compile the provided memory directly.

## 3. Implementation Phases

### Phase 1: Main Thread Binary Fetching
* **Objective:** Intercept the WASM loading phase on the main thread before creating the Worklet node.
* **Instructions:**
    1. Locate where `new AudioWorkletNode(..., 'obr-processor', ...)` is called (likely in `src/audio/OBRDecoder.ts` or `AudioEngine.ts`).
    2. Before instantiating the node, fetch the binary: 
       ```typescript
       const response = await fetch('/obr.wasm');
       const wasmBinary = await response.arrayBuffer();
       ```
    3. Update the `AudioWorkletNode` instantiation to include `wasmBinary` inside `processorOptions`:
       ```typescript
       const obrNode = new AudioWorkletNode(this.audioCtx, 'obr-processor', {
           processorOptions: { 
               order: this.order, 
               sampleRate: this.audioCtx.sampleRate,
               wasmBinary: wasmBinary 
           },
           channelCount: (this.order + 1) * (this.order + 1),
           channelCountMode: 'explicit',
           channelInterpretation: 'discrete',
           outputChannelCount: [2]
       });
       ```
* **TDD Checkpoint:** AGENT INSTRUCTION: Ensure the `fetch` call successfully resolves before the `AudioWorkletNode` is constructed. 

### Phase 2: Worklet Instantiation Override
* **Objective:** Instruct Emscripten to consume the injected binary instead of fetching it.
* **Instructions:**
    1. In `public/worklets/obr-processor.js`, locate the `constructor(options)` method.
    2. Extract the binary from the options: `const wasmBinary = options.processorOptions.wasmBinary;`
    3. Pass this binary into the `ModuleFactory` instantiation block, replacing any `locateFile` logic:
       ```javascript
       ModuleFactory({
           wasmBinary: wasmBinary
       }).then((wasmModule) => {
           this.wasm = wasmModule;
           // Keep your existing _malloc and setup logic here
           this.ready = true;
       }).catch(err => console.error("WASM Instantiation Error:", err));
       ```
* **TDD Checkpoint:** AGENT INSTRUCTION: Execute the build. The browser console must no longer show `ReferenceError: fetch is not defined` or `Aborted(both async and sync fetching of the wasm failed)`.

## 4. Final Review
1. Confirm that `this.ready = true` is successfully reached inside the Worklet.
2. Ensure the audio signal successfully processes without `NaN` errors.