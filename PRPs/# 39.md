# Product Requirements Prompt (PRP)

## 1. Project Context & Objectives
**Project:** AmbiViz (Ambisonic Visualization Application)
**Current State:** We have successfully decoupled and inverted the Pitch for both the primary (Green) and debug (Ghost) visual gaze arrows. However, a regression has occurred: the Audio Yaw (binaural rendering rotation) is reversed again. Turning the physical head left pans the audio left, breaking the illusion of a stationary sound field. 
**Objective:** Permanently fix and isolate the Audio Yaw inversion without regressing the visual mesh Pitch inversions (Green/Ghost arrows) or the overarching 3DOF camera constraints from PRP #25. The worker agent likely mutated a shared state or overwrote the SharedArrayBuffer (SAB) bridge logic during the last update. We must strictly enforce immutability on the core tracking state.

## 2. Technical Decisions & Dependencies
* **Architectural Pattern (Strict State Isolation):** The core tracking quaternions (`currentQuaternion`, `predictedQuaternion`) MUST remain the absolute source of truth and must **never** be mutated by rendering or audio bridges. 
* **Mathematical Implementation (Audio SAB Bridge):**
  1. Locate the exact method where the head-tracking quaternion is written to the Audio `SharedArrayBuffer` (likely in `src/HeadTrackingService.ts`, `AudioEngine.ts`, or a dedicated SAB sync loop).
  2. Extract the Euler angles from the source tracking quaternion using `'YXZ'` order.
  3. Invert the Yaw explicitly: $Yaw_{audio} = -Yaw_{tracker}$ (negate the `y` axis).
  4. Construct a dedicated $Q_{audio}$ using the modified Euler.
  5. Write $Q_{audio}$ to the SAB Float32Array.
* **Performance Constraints:** Do not instantiate `new THREE.Euler()` or `new THREE.Quaternion()` inside the high-frequency sync loop. Use pre-allocated, class-scoped transient variables (e.g., `_audioEuler`, `_audioQuat`).

## 3. Implementation Phases

### Phase 1: Test-Driven Development (TDD) for SAB Isolation
* **Objective:** Establish an ironclad regression test that proves the Audio SAB receives an inverted Yaw while the source tracking quaternion remains completely untouched.
* **Instructions:** Open the test file responsible for the SAB bridge (e.g., `HeadTrackingService.test.ts`). Write assertions that explicitly check both the source state and the resulting SAB float array.
* **TDD Checkpoint:**
    * **Test Case 1:** [Given a simulated head movement to the LEFT (Positive Yaw, e.g., $\pi/4$), When the SAB sync routine executes, Assert that the extracted Euler Y from the SAB quaternion is exactly $-\pi/4$, AND Assert that the source tracking quaternion's Y value remains positive.]
    * **Test Case 2:** [Given the same simulated movement, Assert that the Pitch (X) and Roll (Z) values in the SAB perfectly match the source tracking state (preserving PRP #25 logic).]
    * **Mocking Requirements:** Mock the `SharedArrayBuffer` and its `Float32Array` view. You must be able to read the $x, y, z, w$ floats written to it to reconstruct the test quaternion.
    * **AGENT INSTRUCTION:** "Write and execute these tests in the project's testing framework. Ensure they fail initially. Do not proceed to Phase 2 until all tests in this checkpoint output a PASS."

### Phase 2: Implement Isolated Audio Yaw Inversion
* **Objective:** Apply the Yaw inversion strictly to the OBR Audio pipeline without mutating the shared tracking state.
* **Instructions:** 1. Navigate to the SAB write loop (where `Float32Array.set()` or direct index assignment `[0], [1], [2], [3]` occurs for the audio worklet).
  2. Ensure you have class-scoped variables: `private _audioEuler = new THREE.Euler(0, 0, 0, 'YXZ');` and `private _audioQuat = new THREE.Quaternion();`.
  3. Inside the sync loop:
     - `this._audioEuler.setFromQuaternion(sourceTrackingQuat, 'YXZ');`
     - `this._audioEuler.y = -this._audioEuler.y;` // Invert Yaw
     - `this._audioQuat.setFromEuler(this._audioEuler);`
     - Write `this._audioQuat.x, y, z, w` into the SAB.
* **TDD Checkpoint:**
    * **Test Case 1:** [Given the full application running, When a user scrubs the UI Yaw slider or moves their head, Assert that the visual camera rotates correctly AND the SAB array receives the mathematically inverted Y-axis equivalent.]
    * **AGENT INSTRUCTION:** "Run the full Vitest suite. Ensure all 60+ previous tests pass. Pay special attention to the Green/Ghost Arrow pitch inversion tests created in the previous PRPsâ€”they MUST NOT fail."

## 4. Final Review
* **AGENT INSTRUCTION:** 1. Manually audit `HeadTrackingService.ts` and `AmbiScene.ts`. Verify that no state mutation is "leaking" between the visual and audio pipelines. They must independently derive their states from the single, pristine tracking source of truth.
  2. Confirm that no memory leaks or GC spikes were introduced (no `new` keywords in the `requestAnimationFrame` or `setInterval` loops).
  3. Provide a clear summary of the exact lines modified to achieve this isolation so the architecture remains documented.