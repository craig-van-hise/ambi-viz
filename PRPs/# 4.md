
# Product Requirements Prompt (PRP)

## 1. Project Context & Objectives

The OBR integration is technically complete but functionally broken in the browser. Audio fails to play upon file drop. The objective is to implement a **Ready State Gate** in the `AudioEngine` and `OBRDecoder` to ensure that audio routing only occurs after the Worklet is registered, the WASM is instantiated, and the initial SOFA file is fully parsed into memory.

## 2. Technical Decisions & Dependencies

* **State Tracking**: `OBRDecoder` must expose a `Promise` or a `ready` boolean that the `AudioEngine` can await.
* **Audio Resume Policy**: Modern browsers require an explicit user gesture to resume the `AudioContext`. We must verify the `audioCtx.state` is transitioned to `running` *after* the file is dropped but *before* the source is started.
* **Logging**: Implement "Signal Path" logging to identify where the audio samples are being dropped (Source -> Analyser -> Decoder -> Destination).

## 3. Implementation Phases

### Phase 10: The "Initialization Gate" Fix

* **Objective:** Ensure `setupGraph` does not connect or start the source until the OBR pipeline is fully hot.
* **Instructions:**
1. In `src/audio/OBRDecoder.ts`, add a `public isInitialized: boolean = false` property.
2. In `OBRDecoder.init()`, set `this.isInitialized = true` only *after* the `addModule` and `AudioWorkletNode` creation are successful.
3. In `OBRDecoder.loadSofa()`, wrap the logic in a `try/catch` and ensure it returns a `Promise<void>`.
4. **CRITICAL:** In `src/audio/AudioEngine.ts`, update `setupGraph`:
* Move the `this.audioCtx.resume()` call to the very beginning of the function.
* Await the decoder initialization and the initial SOFA load:
```typescript
await this.obrDecoder.init();
await this.obrDecoder.loadSofa('/hrtf/MIT_KEMAR_Normal.sofa');

```


* Only *after* these awaits, execute `this.sourceNode.connect(...)` and `this.sourceNode.start()`.




* **TDD Checkpoint:** AGENT INSTRUCTION: Write an async test in `AudioEngine.test.ts` that mocks a slow `loadSofa` (using a delay). Verify that `sourceNode.start` is not called until the `loadSofa` promise resolves. Do not proceed to Phase 11 until this outputs a PASS.

### Phase 11: Worklet Fallback & Signal Debugging

* **Objective:** Prevent silent failures if WASM fails to load.
* **Instructions:**
1. In `public/worklets/obr-processor.js`, add a fallback in the `process` method: If `this.ready` is `false`, instead of returning silence, perform a basic mono pass-through (Input Channel 0 to Output 0 & 1). This allows us to hear "dry" audio if the WASM fails.
2. Add `console.log("OBR Worklet: Processing Started")` inside the first successful call of the `process` loop, but use a flag to only log it once.


* **TDD Checkpoint:** AGENT INSTRUCTION: Verify that the `process` method returns `true` even when `this.ready` is false (to keep the node alive). Do not proceed until this outputs a PASS.

## 4. Final Review

1. Drop an Ambisonic file. Check the console for: "OBR Decoder Initialized", "SOFA Loaded", and "OBR Worklet: Processing Started".
2. Confirm that the `AudioContext.state` is `running` after the drop.
3. Verify that the HRTF dropdown remains functional and doesn't "kill" the audio when changed.

