# Product Requirements Prompt (PRP): Fix SOFA Memory Handoff

## 1. Project Context & Objectives
The WASM engine is successfully processing audio (validated via the diagnostic probe), but the `AudioWorklet` thread is crashing when receiving the `LOAD_SOFA` message. The error `Cannot read properties of undefined (reading 'buffer')` indicates that `this.wasm.memory` is undefined. The objective is to safely copy the SOFA payload into the WASM heap using Emscripten's guaranteed `HEAPU8` view instead.

## 2. Technical Decisions
* **Memory Copying**: Instead of constructing a new `Uint8Array` over `this.wasm.memory.buffer`, we will use `this.wasm.HEAPU8.set()` to write the payload directly to the allocated byte pointer.

## 3. Implementation Phases

### Phase 1: Patching `handleMessage`
* **Objective:** Safely allocate memory and copy the SOFA `ArrayBuffer` without crashing the Worklet.
* **Instructions:**
    1. Open `public/worklets/obr-processor.js`.
    2. Locate the `handleMessage(event)` method.
    3. Rewrite the `LOAD_SOFA` logic to exactly match this pattern:
       ```javascript
       handleMessage(event) {
           if (event.data.type === 'LOAD_SOFA') {
               if (!this.wasm || !this.wasm._malloc) {
                   console.warn("WASM not ready for SOFA yet");
                   return;
               }
               
               const payload = event.data.payload; // This is an ArrayBuffer
               const size = payload.byteLength;
               
               // 1. Allocate memory on the WASM heap
               const ptr = this.wasm._malloc(size);
               
               // 2. Copy the bytes safely using HEAPU8
               const payloadBytes = new Uint8Array(payload);
               this.wasm.HEAPU8.set(payloadBytes, ptr);
               
               // 3. Hand the pointer to the C++ parser
               this.wasm._obr_load_sofa(ptr, size);
               
               // 4. Free the memory to prevent leaks
               this.wasm._free(ptr);
               
               console.log("OBRProcessor: SOFA loaded successfully.");
           }
       }
       ```

* **TDD Checkpoint:** AGENT INSTRUCTION: Reload the browser. Drop an audio file. Verify that the console logs `OBRProcessor: SOFA loaded successfully.` and that the `Uncaught TypeError` is completely eliminated.