# Product Requirements Prompt (PRP): Stationary World & Orientation Recovery

## 1. Project Context & Objectives
The project is pivoting to a **Stationary World** model. The 3D scene (the horizon and grid) must remain fixed while head tracking is active. Instead of the camera moving, the user's orientation will be represented by 3D "Nose-Pointer" arrows and reflected in the audio field rotation.

**Current Failures to Fix:**
* **Audio Yaw Inversion:** Looking left currently pans audio left. It must pan right (fixed sound source becomes relative right).
* **Pitch Inversion:** Pitching up currently moves arrows and audio in the wrong direction.
* **UI Telemetry:** Camera orientation sliders are currently static during tracking; they must mirror head tracking data in real-time.

## 2. Technical Decisions & Dependencies
* **Coordinate Sign Mapping:**
    * **Audio Yaw:** Apply `invertedYaw = -rawYaw` before sending to the `OBRDecoder` (SAB).
    * **Audio Pitch:** Apply `invertedPitch = -rawPitch`.
    * **Visual Arrow Pitch:** Correct the `ArrowGroup` rotation so `+Pitch` (Up) results in the arrow mesh tilting UP in Three.js space.
* **State Decoupling:** * When `isTracking` is `true`, the UI sliders (Yaw/Pitch/Roll) must become **read-only observers** of the tracker's output.
    * The `camera.rotation` must be hard-clamped to `(0, 0, 0)` in "Inside View" to ensure the world stays still.

## 3. Implementation Phases

### Phase 1: Camera Origin Lock & UI Sync
* **Objective:** Stabilize the visual world and sync sliders to tracker data.
* **Instructions:**
    1.  In the `animate` loop (`AmbiScene.ts`), if `viewMode === 'inside'` and `isTracking` is active, enforce `camera.rotation.set(0, 0, 0)` and `camera.position.set(0, 0, 0)`.
    2.  Update the `App.tsx` state so that `currentYaw`, `currentPitch`, and `currentRoll` are updated by the `HeadTrackingService` even when tracking is on.
    3.  In `CameraControlPanel.tsx`, disable manual slider interaction (e.g., `pointer-events: none`) when `isTracking` is true, but ensure the `value` prop still reflects the tracker's state.
* **TDD Checkpoint:**
    * **Test Case 1:** Given tracking is ON, When head moves left, Assert Yaw slider in UI moves to reflect the angle.
    * **Test Case 2:** Given tracking is ON, Assert `camera.quaternion` remains `(0,0,0,1)` regardless of tracker input.

### Phase 2: Audio Orientation Inversion
* **Objective:** Fix the "Audio moving with the head" bug.
* **Instructions:**
    1.  Locate the orientation update logic in `OBRDecoder.ts` or the `HeadTrackingService` bridge to the `SharedArrayBuffer`.
    2.  Invert the signs for Yaw and Pitch: `dataView.setFloat32(YAW_OFFSET, -trackerYaw)` and `dataView.setFloat32(PITCH_OFFSET, -trackerPitch)`.
* **TDD Checkpoint:**
    * **Test Case 1:** Given a "Look Left" ($+\theta$) tracker input, Assert the value written to the OBR Worklet is $-\theta$ (Rotate soundfield right).
    * **Test Case 2:** Given a "Look Up" ($+\phi$) tracker input, Assert the value written to OBR is $-\phi$.

### Phase 3: Visual Arrow Pitch Alignment
* **Objective:** Ensure the 3D arrows behave like a laser pointer on the user's nose.
* **Instructions:**
    1.  In `AmbiScene.ts`, update the rotation application for `ActualArrow` and `GhostArrow`.
    2.  Align the mesh rotation axes so that tilting your head UP makes the arrow point UP, and looking LEFT makes the arrow point LEFT. 
    3.  Ensure this is decoupled from the Audio Inversion (Arrows = User Direction; Audio = Inverse World Rotation).
* **TDD Checkpoint:**
    * **Test Case 1:** Given tracker Pitch is UP, Assert Arrow Mesh `rotation.x` tilts the tip of the arrow toward the top of the screen.

## 4. Final Review
* **Visual:** Is the world stationary? Do the sliders move with your head?
* **Audio:** When you look toward a sound source, does it move to the center of your "head" (stereo center)?
* **Telemetry:** Does the UI accurately represent the tracker's raw output?

**AGENT INSTRUCTION:** "Do not proceed to Phase 3 until Phase 2 audio inversions are verified by the user to be perceptually correct."