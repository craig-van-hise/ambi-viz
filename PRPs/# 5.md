
# Product Requirements Prompt (PRP): OBR Source & Build

## 1. Project Context & Objectives

The application is currently failing because `public/obr.wasm` is missing or corrupted (404). We will now move from placeholder logic to a **Production Build**. You are required to clone the official Google OBR source code and compile it into a WebAssembly binary that exports the C++ rendering logic for use in our `AudioWorklet`.

## 2. Technical Decisions & Dependencies

* **Source**: `https://github.com/google/obr`.
* **Compiler**: Emscripten (`emcc`).
* **Core Logic**: You must wrap the `ObrImpl` C++ class.
* **Memory**: Standard WASM heap management.

## 3. Implementation Phases

### Phase 12: Source Acquisition & Tooling Setup

* **Objective**: Clone the OBR repository and verify the Emscripten environment.
* **Instructions**:
1. Open a terminal and clone the repository into a `deps/` directory: `git clone https://github.com/google/obr.git deps/obr`.
2. Verify `emcc` is installed. If not, provide instructions to the user to install the **Emscripten SDK (emsdk)**.
3. Identify the core source files: `obr/src/obr_impl.cc` and headers in `obr/include/`.


* **TDD Checkpoint**: AGENT INSTRUCTION: Verify the `deps/obr` directory exists and contains `README.md` and `src/`. Do not proceed until verified.

### Phase 13: C++ Wrapper for WASM Exports

* **Objective**: Create a bridge between our JS requirements and the OBR C++ API.
* **Instructions**:
1. Create `src/audio/obr_wrapper.cpp`.
2. Include `obr/include/obr.h`.
3. Implement the following `EMSCRIPTEN_KEEPALIVE` functions:
* `_obr_init(int order, float sampleRate)`: Instantiates `ObrImpl`.
* `_obr_process(float* in, float* out, int frames)`: Calls `ObrImpl::Process`.
* `_obr_load_sofa(void* ptr, int size)`: Passes binary SOFA data to the renderer.




* **TDD Checkpoint**: AGENT INSTRUCTION: Perform a dry-run compilation of the C++ wrapper to check for syntax errors. Do not proceed until the C++ code is valid.

### Phase 14: The Final Build

* **Objective**: Generate the `public/obr.wasm` binary.
* **Instructions**:
1. Run the `emcc` command to compile the OBR source and your wrapper:
```bash
emcc src/audio/obr_wrapper.cpp deps/obr/src/*.cc \
  -I deps/obr/include \
  -s WASM=1 -s EXPORTED_FUNCTIONS="['_malloc', '_free', '_obr_init', '_obr_process', '_obr_load_sofa']" \
  -s MODULARIZE=1 -s EXPORT_ES6=1 \
  -O3 -o public/obr.wasm

```


2. Ensure the output is exactly `public/obr.wasm`.


* **TDD Checkpoint**: AGENT INSTRUCTION: Verify the file `public/obr.wasm` exists and its size is > 0 KB. Run the application and verify the "Magic Word" error is gone.

## 4. Final Review

1. Verify the audio signal is now spatialized (binaural) rather than just mono pass-through.
2. Ensure the `RawCoefAnalyser` is still feeding the visualizer correctly.

