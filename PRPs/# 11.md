# Product Requirements Prompt (PRP): AudioWorklet Global Polyfills

## 1. Project Context & Objectives
The Emscripten WASM instantiation is failing with `ReferenceError: URL is not defined` inside `findWasmBinary`. This occurs because Emscripten's boilerplate attempts to use browser-specific globals (`URL`, `document`, `window`) that do not exist in the restrictive `AudioWorkletGlobalScope`, even when a raw `wasmBinary` is explicitly provided. The objective is to inject lightweight polyfills into the Worklet scope to pacify Emscripten's internal checks.

## 2. Technical Decisions
* **Scope Injection**: We will attach dummy `URL`, `window`, and `document` objects directly to `globalThis` inside the Worklet before `ModuleFactory` is invoked.
* **Preserve `wasmBinary`**: The `ArrayBuffer` handoff implemented in the previous phase remains the correct architecture and must be preserved.

## 3. Implementation Phases

### Phase 1: Injecting the Emscripten Pacifier (Polyfills)
* **Objective:** Prevent Emscripten from crashing when it probes the environment.
* **Instructions:**
    1. Open `public/worklets/obr-processor.js`.
    2. Immediately before the `class OBRProcessor extends AudioWorkletProcessor` declaration, inject the following global polyfills to mock the missing browser APIs:
       ```javascript
       // --- EMSCRIPTEN WORKLET POLYFILLS ---
       if (typeof globalThis.URL === 'undefined') {
           globalThis.URL = class URL {
               constructor(url, base) { this.href = url; }
               toString() { return this.href; }
           };
       }
       if (typeof globalThis.window === 'undefined') {
           globalThis.window = globalThis;
       }
       if (typeof globalThis.document === 'undefined') {
           globalThis.document = { baseURI: 'http://localhost/' };
       }
       // ------------------------------------
       ```
    3. Ensure that inside the constructor, `ModuleFactory({ wasmBinary: options.processorOptions.wasmBinary })` remains exactly as it is.

* **TDD Checkpoint:** AGENT INSTRUCTION: Execute the application. Dropping a file must no longer throw `ReferenceError: URL is not defined` inside `obr.js`. Verify that the diagnostic probe (`=== WASM AUDIO DIAGNOSTIC ===`) finally prints out successfully.

## 4. Final Review
1. The `OBR Worklet: Processing Started` log should now be accompanied by the diagnostic readouts.
2. If the Output Left/Right arrays contain non-zero floats, the WASM engine is actively processing the audio.