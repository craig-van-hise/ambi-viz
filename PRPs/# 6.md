

# Product Requirements Prompt (PRP): Autonomous OBR Build

## 1. Project Context & Objectives

The project is stalled at the compilation stage. You have the OBR source and the wrapper, but `public/obr.wasm` does not exist because of missing tooling. Your objective is to **autonomously provision the build environment** and execute the compilation. Do not ask the user for permission to install standard build tools.

## 2. Technical Decisions & Dependencies

* **Toolchain**: Emscripten (emsdk).
* **Dependencies**: OBR requires **Eigen** and **Abseil**. You must fetch these into the `deps/` folder during the build phase.
* **Binaural Logic**: Google's OBR is a high-performance renderer designed for the IAMF format. It uses a native C++ implementation of Ambisonic-to-Binaural rendering.

## 3. Implementation Phases

### Phase 14: Autonomous Toolchain & Dependency Provisioning

* **Objective**: Setup `emsdk`, `Eigen`, and `Abseil` without user intervention.
* **Instructions**:
1. **EMSCRIPTEN**: In the root of the project, clone `https://github.com/emscripten-core/emsdk.git`.
2. Run the installation/activation commands: `./emsdk install latest && ./emsdk activate latest`.
3. **EIGEN**: Clone `https://gitlab.com/libeigen/eigen.git` into `deps/eigen`.
4. **ABSEIL**: Clone `https://github.com/abseil/abseil-cpp.git` into `deps/abseil-cpp`.


* **TDD Checkpoint**: AGENT INSTRUCTION: Verify the existence of `emsdk/upstream/emscripten/emcc`, `deps/eigen/Eigen/Core`, and `deps/abseil-cpp/absl/`. Do not proceed until these paths are valid.

### Phase 15: Full-Stack Compilation

* **Objective**: Generate the final `public/obr.wasm` with correct header paths.
* **Instructions**:
1. Source the emscripten environment: `source ./emsdk/emsdk_env.sh`.
2. Execute the build using the corrected OBR internal paths:
```bash
emcc src/audio/obr_wrapper.cpp \
  deps/obr/obr/renderer/*.cc \
  deps/obr/obr/ambisonic_binaural_decoder/*.cc \
  deps/obr/obr/ambisonic_binaural_decoder/binaural_filters/*.cc \
  deps/obr/obr/ambisonic_encoder/*.cc \
  deps/obr/obr/ambisonic_rotator/*.cc \
  deps/obr/obr/audio_buffer/*.cc \
  -I deps/obr \
  -I deps/eigen \
  -I deps/abseil-cpp \
  -s WASM=1 \
  -s EXPORTED_FUNCTIONS="['_malloc', '_free', '_obr_init', '_obr_process', '_obr_load_sofa']" \
  -s MODULARIZE=1 \
  -s EXPORT_ES6=1 \
  -O3 -msimd128 -o public/obr.wasm

```


3. **Note**: Use `-msimd128` for the performance boost OBR expects.


* **TDD Checkpoint**: AGENT INSTRUCTION: Assert that `public/obr.wasm` exists and is a valid WASM binary.

### Phase 16: Signal Path Verification

* **Objective**: Ensure the browser recognizes the new binary and plays audio.
* **Instructions**:
1. Restart the Vite dev server.
2. Drop an Ambisonic file.
3. Verify the console output: `OBR Engine: Production WASM Loaded`.


* **TDD Checkpoint**: AGENT INSTRUCTION: Run the `OBRDecoder` integration tests. They must now pass using the *real* binary instead of a mock.

## 4. Final Review

1. Remove the `scripts/generate_mock_wasm.js` file to prevent future confusion.
2. Ensure `RawCoefAnalyser` is still driving the Spherical Harmonics visualizer.

