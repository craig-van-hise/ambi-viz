# Product Requirements Prompt (PRP)

## 1. Project Context & Objectives
You are executing a high-priority UI/UX refinement pass on the AmbiViz application. The objective is to resolve interaction mismatches in the transport and queue components, improve the visual state of the Inside/Outside view toggle, and implement mathematically bounded zoom capabilities for the interior 3D visualizer.

## 2. Technical Decisions & Dependencies
* **Track Queue Interaction:** The `onClick` handler for playback must be migrated to `onDoubleClick`. Single clicks should only highlight/select the track (if applicable) without playing.
* **FOV Mathematics:** Three.js `PerspectiveCamera.fov` dictates the *vertical* FOV. To cap the camera at a target horizontal FOV ($FOV_h$) of $160^\circ$ (the mathematical safe limit for rectilinear projection), you must calculate the maximum vertical FOV dynamically based on the window aspect ratio using this exact formula:
  $$FOV_{v} = 2 \arctan\left(\frac{\tan(FOV_{h}/2)}{\text{aspect}}\right) \cdot \frac{180}{\pi}$$
  Do not attempt a $180^\circ$ $FOV_h$, as it causes projection matrix singularity.

## 3. Implementation Phases

### Phase 1: Track Selection Logic (Double-Click)
* **Objective:** Prevent accidental playback on single clicks in the Track Queue.
* **Instructions:**
    1. Open `src/components/TrackQueue.tsx`.
    2. Modify the track button element. Change the `onClick` event that triggers `onTrackSelect` to `onDoubleClick`.
    3. Ensure that if there is a separate state for purely "selecting" or highlighting a track without playing it, that remains bound to `onClick`.
* **TDD Checkpoint:** AGENT INSTRUCTION: Write or update the component test for `TrackQueue.tsx`. Assert that a single click does NOT fire the playback callback, and a double-click DOES fire it. Do not proceed until tests PASS.

### Phase 2: Transport Control Consolidation & Auto-Play
* **Objective:** Streamline the transport bar and enforce auto-play on track navigation.
* **Instructions:**
    1. Open `src/components/TransportControls.tsx`.
    2. Locate the separate "Play" (▶) and "Pause" (⏸) buttons. Combine them into a single, conditional toggle button.
       * If `playbackState === 'playing'`, display the Pause icon and bind `onClick={onPause}`.
       * If `playbackState === 'paused'` or `'stopped'`, display the Play icon and bind `onClick={onPlay}`.
    3. Ensure the engine's `prev()` and `next()` methods (likely in `src/audio/AudioEngine.ts` or the parent component) explicitly await `loadTrack()` and immediately call `play()` to satisfy the Auto-Play requirement.
* **TDD Checkpoint:** AGENT INSTRUCTION: Verify the unified Play/Pause button renders correctly based on `playbackState`. Assert that invoking `next()` or `prev()` results in an eventual `playbackState === 'playing'`. Do not proceed until verified.

### Phase 3: Inside/Outside View Toggle Refactoring
* **Objective:** Replace ambiguous single-button view state with a clear, dual-state UI toggle.
* **Instructions:**
    1. Locate the View Mode selection UI (likely in `App.tsx` or a dedicated control component).
    2. Replace the single string-based button with a side-by-side Segmented Control / Two-Sided Toggle (e.g., a pill-shaped container with "Inside" and "Outside" halves).
    3. Apply an `.active` CSS class to the currently selected mode to explicitly communicate the state (e.g., contrasting background color).
* **TDD Checkpoint:** AGENT INSTRUCTION: Ensure the new toggle correctly switches the boolean/enum state driving the Three.js camera position. Verify UI styling updates conditionally.

### Phase 4: Inside View Zoom & FOV Bounding
* **Objective:** Enable interior zooming via Command+Scroll while strictly capping the horizontal FOV to prevent graphical singularity.
* **Instructions:**
    1. Open `src/visualizer/AmbiScene.ts` (or the component managing `OrbitControls` / Camera).
    2. Ensure Command/Ctrl + Scroll wheel adjusts the camera's FOV (or zoom property) when in "Inside" mode.
    3. Implement a clamp on the maximum zoom-out limit. Convert a target maximum horizontal FOV of $160^\circ$ ($2.79253$ radians) to the maximum allowable vertical FOV using the provided aspect ratio formula:
       `const maxVerticalFov = 2 * Math.atan(Math.tan(160 * Math.PI / 360) / camera.aspect) * (180 / Math.PI);`
    4. Clamp `camera.fov` so it never exceeds `maxVerticalFov`. Call `camera.updateProjectionMatrix()` whenever FOV is altered.
* **TDD Checkpoint:** AGENT INSTRUCTION: Test the interior zoom functionality. Log the FOV adjustments and strictly assert that the mathematically derived maximum vertical FOV is never breached, regardless of extreme scrolling.

## 4. Final Review
1. Confirm that double-clicking a track initiates playback.
2. Confirm the Play/Pause button is a single, state-aware element.
3. Verify that zooming rapidly backwards inside the sphere does not cause the WebGL context to tear, invert, or render black.